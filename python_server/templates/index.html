<html>
<head>
    <link rel="stylesheet" href="static/leaflet/dist/leaflet.css"/>
    <script src="static/jquery.min.js"></script>
    <script src="static/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="static/plugins/easy-button.css">
    <script src="static/plugins/easy-button.js"></script>


  <style>
      #map{ height: {{ heightDiv }}px ; width: {{ widthDiv }}px;}
      .leaflet-container {
        background: #dddddd;
    }
    .box {
      width: {{widthDiv}}px;
      overflow: hidden;
    }
    </style>
</head>

<body>
    <button onclick="reset()">Reset</button>
    <button onclick="redraw()">Redraw</button>
    <button onclick="random()">Random</button>
    <!--
    <button onclick="sort()">Sort</button>
    <button onclick="filter()">Filter</button>
    -->
  <div class="box">
    <div style="width:  2550px; float:left;">
    <div id="map"></div>
  </div>
  </div>
  <div style="overflow: hidden;">
    <p id="galaxy">
    </p>
    <button style="visibility: hidden;" id="remove" onclick="blacklist()">Remove</button>
    <button style="visibility: hidden;" id="elliptical" onclick="elliptical()">Elliptical</button>
    <button style="visibility: hidden;" id="spiral" onclick="spiral()">Spiral</button>

    <br>
  </div>
      <script>

      var map = L.map('map', {
        dragging: true,
        zoomDelta: 1,
        attributionControl: false,
        zoomControl:false,
        }).setView([0,0], 0);

      var layer = L.tileLayer('http://localhost:{{ serverPort }}/?x={x}&y={y}&z={z}&inv={inv}',
        {
          inv: 0,
          maxZoom: {{ maxZoom }},
          minZoom: {{ minZoom }},
          tileSize: {{ tileSize }},
          noWrap: true,
          crs: L.CRS.Simple
        })

        map.addLayer(layer);
        polygon = L.polygon([[0,0],[0,0.0001]]);
        map.addLayer(window.polygon);

        map.on('dblclick', function(event){
          //console.log(event.latlng);
          var pp = event.latlng;
          var zz = map.getZoom();
          var dd = map.project(L.latLng(pp.lat,pp.lng),map.getMaxZoom);
          vx = Math.floor(dd.x*{{ tilesX }});
          vy = Math.floor(dd.y*{{ tilesY }});
          var tileSize = {{ tileSize }};
          console.log(zz, vx, vy);
          map.removeLayer(window.polygon);

          window.coords = [
            map.unproject([vx*tileSize, vy*tileSize], map.getMaxZoom()),
            map.unproject([(vx+1)*tileSize, vy*tileSize], map.getMaxZoom()),
            map.unproject([(vx+1)*tileSize, (vy+1)*tileSize], map.getMaxZoom()),
            map.unproject([vx*tileSize, (vy+1)*tileSize], map.getMaxZoom())
        ];
          window.toDeleteCells = [];
          window.toElliptical = [];
          window.toSpiral = [];
          window.polygon = L.polygon(coords, {color: 'green', fillOpacity: 0.05});
          map.on('keypress', function(event){
            if (event.originalEvent.key == 'd') {
              blacklist();
            };
            if (event.originalEvent.key == 'e') {
              elliptical();
            }
            if (event.originalEvent.key == 's') {
              spiral();
            }
            });
          if (zz > 2){
          $.get("http://localhost:{{ serverPort }}/info", {x:vx, y:vy}, function(data, status){
             console.log(`${data}`);
             if (data == '') {
             map.removeLayer(window.polygon);
             }
             else {
                 map.addLayer(window.polygon);
             }
             document.getElementById("galaxy").innerHTML = "Galaxy information : " + data;
             document.getElementById("remove").style.visibility = "visible";
             document.getElementById("elliptical").style.visibility = "visible";
             document.getElementById("spiral").style.visibility = "visible";
             window.toRemove = data;
          });
        };
          });

        var southWest = map.unproject([{{ minYrange }}, {{ maxYrange }}], map.getMaxZoom());
        var northEast = map.unproject([{{ maxXrange }}, {{ minXrange }}], map.getMaxZoom());
        map.setMaxBounds(new L.LatLngBounds(southWest, northEast));

        L.easyButton( '<span class="star">&starf;</span>', function(){
          if (layer.options.inv == 0) {
            layer.options.inv = 1 ;
          }
          else {
            layer.options.inv = 0;
          }
          layer.redraw();
        }).addTo(map);

        function blacklist() {
          map.removeLayer(window.polygon);
          window.toDeleteCells.push(coords);
          window.multipolygon = L.polygon(window.toDeleteCells, {color: 'red', fillOpacity: 0.01});
          map.addLayer(window.multipolygon);
          $.get("http://localhost:{{ serverPort }}/black", {gid:window.toRemove});
        }

        function elliptical() {
          map.removeLayer(window.polygon);
          window.toElliptical.push(coords);
          window.multipolygonE = L.polygon(window.toElliptical, {color: 'orange', fillOpacity: 0.01});
          map.addLayer(window.multipolygonE);
        }
        function spiral() {
          map.removeLayer(window.polygon);
          window.toSpiral.push(coords);
          window.multipolygonS = L.polygon(window.toSpiral, {color: 'blue', fillOpacity: 0.01});
          map.addLayer(window.multipolygonS);
        }

        function random() {
         $.get("http://localhost:{{ serverPort }}/random");
          location.reload(true);
          map.removeLayer(layer);
          map.addLayer(layer);
          layer.redraw();
          }
        function sort() {
         $.get("http://localhost:{{ serverPort }}/sort");
          layer.redraw();
          }
        function redraw() {
         $.get("http://localhost:{{ serverPort }}/redraw");
          location.reload(true);
          map.removeLayer(layer);
          map.addLayer(layer);
          layer.redraw();
          }
        function reset() {
         $.get("http://localhost:{{ serverPort }}/reset");
          location.reload(true);
          map.removeLayer(layer);
          map.addLayer(layer);
          layer.redraw();
          }
        function filter() {
         $.get("http://localhost:{{ serverPort }}/filter");
          layer.redraw();
          }
      </script>

</body>
</html>
