<html>
<head>
    <link rel="stylesheet" href="static/leaflet/dist/leaflet.css"/>
    <script src="static/jquery.min.js"></script>
    <script src="static/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="static/plugins/easy-button.css">
    <script src="static/plugins/easy-button.js"></script>


  <style>
      #map{ height: {{ heightDiv }}px ; width: {{ widthDiv }}px;}
      .leaflet-container {
        background: #dddddd;
    }
    .box {
      width: {{widthDiv}}px;
      overflow: hidden;
    }

    .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255,255,255,0.8);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
    }
    .info h4 {
        margin: 0 0 5px;
        color: #777;
    }

    </style>
</head>

<body>
    <button onclick="reset()">Reset</button>
    <button onclick="redraw()">Redraw</button>
    <button onclick="random()">Random</button>
    <!--
    <button onclick="sort()">Sort</button>
    <button onclick="filter()">Filter</button>
    -->
  <div class="box">
    <div style="width:  2550px; float:left;">
    <div id="map"></div>
  </div>
  </div>
  <div style="overflow: hidden;">

    {% for idx, cl in enumerate(classes) %}
    <button style="visibility: hidden;" id="button_{{ idx }}" onclick="custom({{ list(cl.values())[0] }})">{{ list(cl.keys())[0] }}({{ list(cl.values())[0] }})</button>
    {% end %}

  </div>
      <script>

      document.getElementById("map").onkeydown = function (e) {
      		if(e.keyCode == '54') {
      			 e.stopPropagation();
      		}
      	};

      var map = L.map('map', {
        dragging: true,
        zoomDelta: 1,
        attributionControl: false,
        zoomControl:false,
        keyboardPanDelta: 80,
        }).setView([0,0], 0);

        var info = L.control();

        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
            this.update();
            return this._div;
        };

        // method that we will use to update the control based on feature properties passed
        info.update = function (props) {
            this._div.innerHTML = '<h4>Image information</h4> <br />' +
            ( props ? 'Name: ' + props.name + '<br /> Class: ' + props.class +
            '<br /><button onclick="clear_selected()"> Clear</button>' : '');
        };

        info.addTo(map);


      var layer = L.tileLayer('{{ serverHost }}:{{ serverPort }}/?x={x}&y={y}&z={z}&inv={inv}',
        {
          inv: 0,
          maxZoom: {{ maxZoom }},
          minZoom: {{ minZoom }},
          tileSize: {{ tileSize }},
          noWrap: true,
          crs: L.CRS.Simple
        })

        map.addLayer(layer);
        polygon = L.polygon([[0,0],[0,0.0001]]);
        map.addLayer(window.polygon);
        //map.keyboard.disable();

        window.colors = ['pink','sienna','cyan','olive','azure','red', 'blue', 'orange', 'magenta', 'yellow'];
        window.classesName = new Array(10);
        window.validClassesCode = []
        {% for idx, cl in enumerate(classes) %}
        window.validClassesCode.push( {{ list(cl.values())[0] }} );
        window.classesName[{{ list(cl.values())[0] }}] = '{{ list(cl.keys())[0] }}';
       {% end %}
       window.classifiedTiles = {};


        function getCoords(vx,vy,tileSize){
            var temp_coords = [
            map.unproject([vx*tileSize, vy*tileSize], map.getMaxZoom()),
            map.unproject([(vx+1)*tileSize, vy*tileSize], map.getMaxZoom()),
            map.unproject([(vx+1)*tileSize, (vy+1)*tileSize], map.getMaxZoom()),
            map.unproject([vx*tileSize, (vy+1)*tileSize], map.getMaxZoom())
            ];
            return temp_coords;
        };

	function selectTile(vx,vy,tileSize,zz){
        console.log('zoom = ',zz,'vz = ',vx,'vy = ', vy);
        map.removeLayer(window.polygon);
        window.coords = getCoords(vx,vy,tileSize);
        window.polygon = L.polygon(coords, {color: 'green', fillOpacity: 0.05});
        if (zz >= {{ minZoom }} ){
            $.get("{{ serverHost }}:{{ serverPort }}/info", {x:vx, y:vy}, function(data, status){
            console.log(data.name, data.class);
            if (data.name == '') {
              map.removeLayer(window.polygon);
              }
            else {
              map.addLayer(window.polygon);
              }
            if (data.class >= 0) {
               if (window.classifiedTiles[data.name] == undefined) {
               window.classifiedTiles[data.name] = {
                'class'  : data.class,
                'polygon': L.polygon(window.coords, {color: window.colors[data.class],  fillOpacity: 0.12}) };
            };
            };
            window.selected = data.name;
            var props = { 'name': window.selected, 'class':  window.classesName[data.class] }
            info.update(props);
          });
        };
	 };

        map.on('dblclick', function(event){
          //console.log(event.latlng);
          var pp = event.latlng;
          var dd = map.project(L.latLng(pp.lat,pp.lng),map.getMaxZoom);
          window.zz = map.getZoom();
          window.vx = Math.floor(dd.x*{{ tilesX }});
          window.vy = Math.floor(dd.y*{{ tilesY }});
          window.tileSize = {{ tileSize }};
	      selectTile(vx,vy,tileSize,zz);
            {% for idx, cl in enumerate(classes) %}
            document.getElementById("button_{{ idx }}").style.visibility = "visible";
            {% end %}
            document.getElementById("clear").style.visibility = "visible";
          });


	  map.on('keypress', function(event){
        //console.log(event.originalEvent.keyCode);
	    event.originalEvent.preventDefault();
	    event.originalEvent.stopPropagation();

	    if (event.originalEvent.keyCode == 119) {
              vy = vy-1;
	          selectTile(vx,vy,tileSize,zz);
              var shift = -1*tileSize/Math.pow(2,map.getMaxZoom()-map.getZoom());
              map.panBy(L.point(0,shift));
              };


            if (event.originalEvent.keyCode == 97) {
              vx = vx-1;
	          selectTile(vx,vy,tileSize,zz);
              var shift = -1*tileSize/Math.pow(2,map.getMaxZoom()-map.getZoom());
              map.panBy(L.point(shift,0));
            };

	    if (event.originalEvent.keyCode == 115) {
              vy = vy+1;
	          selectTile(vx,vy,tileSize,zz);
              var shift = 1*tileSize/Math.pow(2,map.getMaxZoom()-map.getZoom());
              map.panBy(L.point(0,shift));
            };

	    if (event.originalEvent.keyCode == 100) {
              vx = vx+1;
	          selectTile(vx,vy,tileSize,zz);
              var shift = 1*tileSize/Math.pow(2,map.getMaxZoom()-map.getZoom());
              map.panBy(L.point(shift,0));
            };

            if (event.originalEvent.key == 'c') {clear_selected();};

            if (event.originalEvent.key == '0') {custom(0);};
            if (event.originalEvent.key == '1') {custom(1);};
            if (event.originalEvent.key == '2') {custom(2);};
            if (event.originalEvent.key == '3') {custom(3);};
            if (event.originalEvent.key == '4') {custom(4);};
            if (event.originalEvent.key == '5') {custom(5);};
            if (event.originalEvent.key == '6') {custom(6);};
            if (event.originalEvent.key == '7') {custom(7);};
            if (event.originalEvent.key == '8') {custom(8);};
            if (event.originalEvent.key == '9') {custom(9);};

            });


        var southWest = map.unproject([{{ minYrange }}, {{ maxYrange }}], map.getMaxZoom());
        var northEast = map.unproject([{{ maxXrange }}, {{ minXrange }}], map.getMaxZoom());
        map.setMaxBounds(new L.LatLngBounds(southWest, northEast));

        L.easyButton( '<span class="star">&starf;</span>', function(){
          if (layer.options.inv == 0) {
            layer.options.inv = 1 ;
          }
          else {
            layer.options.inv = 0;
          }
          layer.redraw();
        }).addTo(map);




        function custom(val) {
          var valid = window.validClassesCode.includes(val);
          if (valid){
          console.log(window.classesName[val]);
            if (window.classifiedTiles[window.selected]) {
                console.log('selected already', window.classifiedTiles[window.selected]);
            }
            else {
            window.classifiedTiles[window.selected] = {
                'class'  : val,
                'polygon': L.polygon(window.coords, {color: window.colors[val],  fillOpacity: 0.12}).bindTooltip("my tooltip") };
            map.removeLayer(window.polygon);
            map.removeLayer(window.classifiedTiles[window.selected].polygon);
            map.addLayer(window.classifiedTiles[window.selected].polygon);
            $.get("{{ serverHost }}:{{ serverPort }}/update", {gid:window.selected, class: window.classifiedTiles[window.selected].class });
            var props = { 'name': window.selected, 'class':  window.classesName[val] }
            info.update(props);
            };
          };
      }; //custom

      function clear_selected(){
          if (window.classifiedTiles[window.selected]) {
              map.removeLayer(window.classifiedTiles[window.selected].polygon);
              delete window.classifiedTiles[window.selected];
              map.removeLayer(window.polygon);
              map.addLayer(window.polygon);
              $.get("{{ serverHost }}:{{ serverPort }}/update", {gid:window.selected, class:-1});
              var props = { 'name': window.selected, 'class':  -1 };
              info.update(props);
          };

      }; // clear_selected


        function random() {
         $.get("{{ serverHost }}:{{ serverPort }}/random");
          location.reload(true);
          map.removeLayer(layer);
          map.addLayer(layer);
          layer.redraw();
          }
        function sort() {
         $.get("{{ serverHost }}:{{ serverPort }}/sort");
          layer.redraw();
          }
        function redraw() {
         $.get("{{ serverHost }}:{{ serverPort }}/redraw");
          location.reload(true);
          map.removeLayer(layer);
          map.addLayer(layer);
          layer.redraw();
          }
        function reset() {
         $.get("{{ serverHost }}:{{ serverPort }}/reset");
          location.reload(true);
          map.removeLayer(layer);
          map.addLayer(layer);
          layer.redraw();
          }
        function filter() {
         $.get("{{ serverHost }}:{{ serverPort }}/filter");
          layer.redraw();
          }
      </script>

</body>
</html>
